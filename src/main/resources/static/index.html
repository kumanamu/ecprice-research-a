<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ECPriceResearch Test</title>
    <style>
        body {
            font-family: Arial;
            padding: 30px;
            background: #fafafa;
        }
        .search-box {
            margin-bottom: 20px;
        }
        input {
            width: 300px;
            padding: 8px;
            font-size: 16px;
        }
        button {
            padding: 8px 14px;
            font-size: 15px;
            margin-left: 6px;
            cursor: pointer;
        }
        .toggle-btn {
            background: #333;
            color: white;
            border: none;
        }
        h2 {
            margin-top: 30px;
        }
        .platform-box {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #ddd;
            display: inline-block;
            margin-right: 20px;
        }
        .platform-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .item-img {
            width: 120px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        .price {
            font-size: 18px;
            font-weight: bold;
            color: #e74c3c;
            margin: 10px 0;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .summary {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<h1 id="title">ğŸ”¦ ECPriceResearch ê°€ê²© ë¹„êµ í…ŒìŠ¤íŠ¸</h1>

<button class="toggle-btn" onclick="toggleLang()">ğŸŒ ì–¸ì–´ ì „í™˜</button>

<div class="search-box">
    <label id="labelKeyword">ê²€ìƒ‰ í‚¤ì›Œë“œ</label><br>
    <input id="keyword" placeholder="ì˜ˆ: ì•„ì´í° 13">
    <button onclick="fetchMargin()">ğŸš€ ì¡°íšŒ</button>
</div>

<h2 id="resultTitle">ê²°ê³¼</h2>
<div id="result">ì•„ì§ ì¡°íšŒ ì•ˆí•¨</div>

<script>
    let lang = "ko";

    const words = {
        ko: {
            title: "ğŸ”¦ ECPriceResearch ê°€ê²© ë¹„êµ í…ŒìŠ¤íŠ¸",
            keywordLabel: "ê²€ìƒ‰ í‚¤ì›Œë“œ",
            placeholder: "ì˜ˆ: ì•„ì´í° 13",
            search: "ğŸš€ ì¡°íšŒ",
            result: "ê²°ê³¼",
            noData: "ìƒí’ˆ ì—†ìŒ"
        },
        jp: {
            title: "ğŸ”¦ ECPriceResearch ä¾¡æ ¼æ¯”è¼ƒãƒ†ã‚¹ãƒˆ",
            keywordLabel: "æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰",
            placeholder: "ä¾‹: iPhone 13",
            search: "ğŸš€ æ¤œç´¢",
            result: "çµæœ",
            noData: "ãƒ‡ãƒ¼ã‚¿ãªã—"
        }
    };

    function toggleLang() {
        lang = lang === "ko" ? "jp" : "ko";
        document.getElementById("title").textContent = words[lang].title;
        document.getElementById("labelKeyword").textContent = words[lang].keywordLabel;
        document.getElementById("keyword").placeholder = words[lang].placeholder;
        document.getElementById("resultTitle").textContent = words[lang].result;
    }

    async function fetchMargin() {
        const keyword = document.getElementById("keyword").value;

        if (!keyword) {
            alert("í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }

        const box = document.getElementById("result");
        box.innerHTML = "<p>â³ ì¡°íšŒ ì¤‘...</p>";

        try {
            const res = await fetch(`/api/margin/compare?keyword=${encodeURIComponent(keyword)}&lang=${lang}`);
            if (!res.ok) throw new Error("API ì˜¤ë¥˜: " + res.status);

            const json = await res.json();
            renderResult(json);

        } catch (err) {
            document.getElementById("result").innerHTML =
                "<p style='color: red;'>âŒ ì¡°íšŒ ì‹¤íŒ¨: " + err + "</p>";
        }
    }

    function renderResult(data) {
        const box = document.getElementById("result");
        box.innerHTML = "";

        if (!data) {
            box.innerHTML = "<p>ë°ì´í„° ì—†ìŒ</p>";
            return;
        }

        const platforms = [
            { key: "amazonJp", name: "Amazon JP", flag: "ğŸ‡¯ğŸ‡µ" },
            { key: "rakuten", name: "Rakuten", flag: "ğŸ‡¯ğŸ‡µ" },
            { key: "naver", name: "Naver", flag: "ğŸ‡°ğŸ‡·" },
            { key: "coupang", name: "Coupang", flag: "ğŸ‡°ğŸ‡·" }
        ];

        let html = "";

        // ğŸ”¥ í”Œë«í¼ ì¹´ë“œë¥¼ ìƒì„±
        platforms.forEach(platform => {
            const item = data[platform.key];

            if (!item || !item.productName) return;

            const img = item.productImage || "https://via.placeholder.com/120";
            const price =
                item.priceKrw > 0
                    ? item.priceKrw + " KRW"
                    : item.priceJpy > 0
                    ? item.priceJpy + " JPY"
                    : "ê°€ê²© ì—†ìŒ";

            html += `
                <div class='platform-box'>
                    <div class='platform-title'>${platform.flag} ${platform.name}</div>
                    <img src='${img}' class='item-img'
                         onerror="this.src='https://via.placeholder.com/120'" />
                    <div style="font-size: 14px; margin-bottom: 10px; max-width: 200px;">
                        ${item.productName.substring(0, 50)}...
                    </div>
                    <div class='price'>${price}</div>
                    <a href='${item.productUrl}' target='_blank'>ìƒí’ˆ ë³´ê¸° â†’</a>
                </div>
            `;
        });

        // ğŸ” ê°€ê²© ìš”ì•½
        html += `
            <div style="clear: both; margin-top: 20px;">
                <div class='summary'>
                    <h3>ğŸ’° ê°€ê²© ë¹„êµ ìš”ì•½</h3>
                    <p><strong>ìµœì €ê°€ í”Œë«í¼:</strong> ${data.bestPlatform}</p>
                    <p><strong>í™˜ìœ¨:</strong> 1 JPY = ${data.krwToJpy.toFixed(2)} KRW</p>
                </div>
            </div>
        `;

        // ğŸ¤– AI ìë™ ë¶„ì„ ê²°ê³¼
        if (data.aiAnalysis) {
            const ai = data.aiAnalysis;

            html += `
                <div style="margin-top:30px; background:#fff8e1;
                            padding:20px; border-radius:10px; border:1px solid #e0c97f;">
                    <h3>ğŸ¤– AI ë§ˆì§„ ë¶„ì„ ê²°ê³¼</h3>

                    <p><strong>ì¶”ì²œ êµ¬ë§¤ì²˜:</strong> ${ai.buyRecommendation}</p>
                    <p><strong>ì¶”ì²œ íŒë§¤ì²˜:</strong> ${ai.sellRecommendation}</p>

                    <p><strong>ì˜ˆìƒ ë§ˆì§„:</strong> ${ai.expectedProfitKrw.toLocaleString()} ì›</p>
                    <p><strong>ì˜ˆìƒ ìˆ˜ìµë¥ :</strong> ${ai.expectedProfitRate.toFixed(2)}%</p>

                    <p style="margin-top:10px;"><strong>ğŸ“Œ ë¶„ì„ ì´ìœ :</strong><br>${ai.reason}</p>
                </div>
            `;
        } else {
            html += `
                <div style="margin-top:30px; color:red;">
                    âš  AI ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.
                </div>
            `;
        }

        box.innerHTML = html;
    }
</script>

</body>
</html>
