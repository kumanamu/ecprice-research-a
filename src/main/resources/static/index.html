<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ECPriceResearch Test</title>
    <style>
        body {
            font-family: Arial;
            padding: 30px;
            background: #fafafa;
        }
        .search-box {
            margin-bottom: 20px;
        }
        input {
            width: 300px;
            padding: 8px;
            font-size: 16px;
        }
        button {
            padding: 8px 14px;
            font-size: 15px;
            margin-left: 6px;
            cursor: pointer;
        }
        .toggle-btn {
            background: #333;
            color: white;
            border: none;
        }
        h2 {
            margin-top: 30px;
        }
        .platform-box {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #ddd;
            display: inline-block;
            margin-right: 20px;
            vertical-align: top;
            width: 250px;
        }
        .platform-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .item-img {
            width: 120px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        .price {
            font-size: 18px;
            font-weight: bold;
            color: #e74c3c;
            margin: 10px 0;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .summary {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        #sim-box input {
            width: 200px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

<h1 id="title">ğŸ”¦ ECPriceResearch ê°€ê²© ë¹„êµ í…ŒìŠ¤íŠ¸</h1>

<button class="toggle-btn" onclick="toggleLang()">ğŸŒ ì–¸ì–´ ì „í™˜</button>

<div class="search-box">
    <label id="labelKeyword">ê²€ìƒ‰ í‚¤ì›Œë“œ</label><br>
    <input id="keyword" placeholder="ì˜ˆ: ì•„ì´í° 13">
    <button onclick="fetchMargin()">ğŸš€ ì¡°íšŒ</button>
</div>

<h2 id="resultTitle">ê²°ê³¼</h2>
<div id="result">ì•„ì§ ì¡°íšŒ ì•ˆí•¨</div>

<!-- ğŸ”¥ ì‹œë®¬ë ˆì´ì…˜ UI -->
<h2 style="margin-top:40px;">ğŸ§® ë§ˆì§„ ì‹œë®¬ë ˆì´ì…˜</h2>

<div id="sim-box" style="background:#fff; padding:20px; border-radius:10px; border:1px solid #ddd; width:420px;">
    <label>êµ¬ì…ê°€ (KRW)</label><br>
    <input id="sim-purchase-krw" type="number"><br>

    <label>êµ¬ì…ê°€ (JPY)</label><br>
    <input id="sim-purchase-jpy" type="number"><br>

    <label>í˜„ì§€ ë°°ì†¡ë¹„ (KRW)</label><br>
    <input id="sim-local" type="number"><br>

    <label>í•´ì™¸ ë°°ì†¡ë¹„ (KRW)</label><br>
    <input id="sim-intl" type="number"><br>

    <label>íŒë§¤ ìˆ˜ìˆ˜ë£Œ (%)</label><br>
    <input id="sim-fee" type="number"><br>

    <label>íŒë§¤ê°€ (KRW)</label><br>
    <input id="sim-sell-krw" type="number"><br>

    <label>íŒë§¤ê°€ (JPY)</label><br>
    <input id="sim-sell-jpy" type="number"><br>

    <label>ê´€ì„¸ìœ¨ (%)</label><br>
    <input id="sim-tax" type="number"><br>

    <label>í™˜ìœ¨ (1 JPY â†’ KRW)</label><br>
    <input id="sim-ex" type="number"><br><br>

    <button onclick="runSim()">ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
</div>

<h3 style="margin-top:20px;">ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼</h3>
<div id="sim-result">ì•„ì§ ì‹œë®¬ë ˆì´ì…˜ ì•ˆí•¨</div>

<script>
    let lang = "ko";

    const words = {
        ko: {
            title: "ğŸ”¦ ECPriceResearch ê°€ê²© ë¹„êµ í…ŒìŠ¤íŠ¸",
            keywordLabel: "ê²€ìƒ‰ í‚¤ì›Œë“œ",
            placeholder: "ì˜ˆ: ì•„ì´í° 13",
            search: "ğŸš€ ì¡°íšŒ",
            result: "ê²°ê³¼",
            noData: "ìƒí’ˆ ì—†ìŒ"
        },
        jp: {
            title: "ğŸ”¦ ECPriceResearch ä¾¡æ ¼æ¯”è¼ƒãƒ†ã‚¹ãƒˆ",
            keywordLabel: "æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰",
            placeholder: "ä¾‹: iPhone 13",
            search: "ğŸš€ æ¤œç´¢",
            result: "çµæœ",
            noData: "ãƒ‡ãƒ¼ã‚¿ãªã—"
        }
    };

    function toggleLang() {
        lang = (lang === "ko") ? "jp" : "ko";
        document.getElementById("title").textContent = words[lang].title;
        document.getElementById("labelKeyword").textContent = words[lang].keywordLabel;
        document.getElementById("keyword").placeholder = words[lang].placeholder;
        document.getElementById("resultTitle").textContent = words[lang].result;
    }

   async function fetchMargin() {
    const keyword = document.getElementById("keyword").value;
    if (!keyword) return alert("í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”!");

    const box = document.getElementById("result");
    box.innerHTML = "<p>â³ ì¡°íšŒ ì¤‘...</p>";

    try {
        const res = await fetch(
            `/api/margin/compare?keyword=${encodeURIComponent(keyword)}&lang=${lang}`,
            { method: "GET", timeout: 30000 }  // 30ì´ˆ timeout
        );

        if (!res.ok) {
            throw new Error(`API Error: ${res.status}`);
        }

        const json = await res.json();
        renderResult(json);

    } catch (e) {
        console.error("âŒ ì˜¤ë¥˜:", e);
        box.innerHTML = `<p style='color:red;'>âŒ ì¡°íšŒ ì‹¤íŒ¨: ${e.message}</p>`;
    }
}

    function renderResult(data) {
    const box = document.getElementById("result");
    box.innerHTML = "";

    const platforms = [
        { key: "amazonJp", name: "Amazon JP", flag: "ğŸ‡¯ğŸ‡µ" },
        { key: "rakuten", name: "Rakuten", flag: "ğŸ‡¯ğŸ‡µ" },
        { key: "naver", name: "Naver", flag: "ğŸ‡°ğŸ‡·" },
        { key: "coupang", name: "Coupang", flag: "ğŸ‡°ğŸ‡·" }
    ];

    let html = "";

    platforms.forEach(p => {
        const item = data[p.key];
        if (!item || !item.productName) return;

        // ğŸ”¥ í† ê¸€ì— ë”°ë¼ ì£¼ ê°€ê²©ê³¼ ì°¸ê³  ê°€ê²© ê²°ì •
        let mainPrice, subPrice, mainCurrency, subCurrency;

        if (lang === "ko") {
            // í•œê¸€: ì›í™”(KRW) ì£¼ í‘œì‹œ
            mainPrice = item.priceKrw || (item.priceJpy * data.jpyToKrw);
            subPrice = item.priceJpy || (item.priceKrw / data.jpyToKrw);
            mainCurrency = "KRW";
            subCurrency = "JPY";
        } else {
            // ì¼ë³¸ì–´: ì—”í™”(JPY) ì£¼ í‘œì‹œ
            mainPrice = item.priceJpy || (item.priceKrw / data.jpyToKrw);
            subPrice = item.priceKrw || (item.priceJpy * data.jpyToKrw);
            mainCurrency = "JPY";
            subCurrency = "KRW";
        }

        html += `
            <div class="platform-box">
                <div class="platform-title">${p.flag} ${p.name}</div>
                <img src="${item.productImage}" class="item-img"
                     onerror="this.src='https://via.placeholder.com/120'"/>
                <div>${item.productName}</div>
                <div class="price">${Math.round(mainPrice).toLocaleString()} ${mainCurrency}</div>
                <div style="font-size:12px; color:#666;">ì°¸ê³ : ${Math.round(subPrice).toLocaleString()} ${subCurrency}</div>
                <a href="${item.productUrl}" target="_blank">ìƒí’ˆ ë³´ê¸° â†’</a>
            </div>
        `;
    });

    html += `
        <div style="clear:both;margin-top:20px;">
            <div class="summary">
                <h3>ğŸ’° ê°€ê²© ë¹„êµ ìš”ì•½</h3>
                <p><strong>ìµœì €ê°€ í”Œë«í¼:</strong> ${data.bestPlatform}</p>
                <p><strong>ìµœì €ê°€:</strong> ${
                    lang === "ko"
                        ? data.profitKrw.toLocaleString() + " KRW (ì°¸ê³ : " + Math.round(data.profitJpy).toLocaleString() + " JPY)"
                        : Math.round(data.profitJpy).toLocaleString() + " JPY (ì°¸ê³ : " + data.profitKrw.toLocaleString() + " KRW)"
                }</p>
                <p><strong>í™˜ìœ¨:</strong> 1 JPY = ${data.jpyToKrw.toFixed(2)} KRW</p>
            </div>
        </div>
    `;

    box.innerHTML = html;
}

    /** ğŸ”¥ ì‹œë®¬ë ˆì´ì…˜ fetchë„ ë¬´í•œë£¨í”„ ë°©ì§€ */
    async function runSim() {
        const req = {
            purchasePriceKrw: Number(document.getElementById("sim-purchase-krw").value),
            purchasePriceJpy: Number(document.getElementById("sim-purchase-jpy").value),
            shippingLocal: Number(document.getElementById("sim-local").value),
            shippingInternational: Number(document.getElementById("sim-intl").value),
            platformFee: Number(document.getElementById("sim-fee").value) / 100,
            sellPriceKrw: Number(document.getElementById("sim-sell-krw").value),
            sellPriceJpy: Number(document.getElementById("sim-sell-jpy").value),
            taxRate: Number(document.getElementById("sim-tax").value) / 100,
            exchangeRateJpyToKrw: Number(document.getElementById("sim-ex").value)
        };

        const box = document.getElementById("sim-result");
        box.innerHTML = "<p>â³ ê³„ì‚° ì¤‘...</p>";

        try {
            const res = await fetch("/api/margin/simulation", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(req)
            });

            if (!res.ok) {
                box.innerHTML = "<p style='color:red;'>âŒ ì˜¤ë¥˜ (API ì‹¤íŒ¨)</p>";
                return;
            }

            const json = await res.json();

            box.innerHTML = `
                <div class="summary">
                    <p><strong>ì´ ë¹„ìš© (KRW):</strong> ${json.totalCostKrw.toLocaleString()} ì›</p>
                    <p><strong>ì´ ë¹„ìš© (JPY):</strong> ${json.totalCostJpy.toFixed(2)} ì—”</p>

                    <p><strong>ìˆ˜ìµ (KRW):</strong> ${json.revenueKrw.toLocaleString()} ì›</p>
                    <p><strong>ìˆ˜ìµ (JPY):</strong> ${json.revenueJpy.toFixed(2)} ì—”</p>

                    <p><strong>ë§ˆì§„ (KRW):</strong> ${json.profitKrw.toLocaleString()} ì›</p>
                    <p><strong>ë§ˆì§„ (JPY):</strong> ${json.profitJpy.toFixed(2)} ì—”</p>

                    <p><strong>ìˆ˜ìµë¥  (KRW):</strong> ${json.profitRateKrw.toFixed(2)}%</p>
                    <p><strong>ìˆ˜ìµë¥  (JPY):</strong> ${json.profitRateJpy.toFixed(2)}%</p>
                </div>
            `;
        } catch (e) {
            console.error(e);
            box.innerHTML = "<p style='color:red;'>âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</p>";
        }
    }
</script>

</body>
</html>
